name: Deploy AI Server to AWS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          tags: clairekwak/edison_ai:${{ github.sha }}
          push: true

      - name: Upload nginx config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: ./nginx/nginx.conf    # 리포지토리의 원본 파일
          target: ~/                 # [ ⭐️ 수정 ⭐️ ] /tmp 대신 홈 디렉터리(~)로 전송

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            docker pull clairekwak/edison_ai:${{ github.sha }}

            # 기존 컨테이너 중지 및 삭제
            docker stop edison-ai-server || true
            docker rm edison-ai-server || true

            # 새 컨테이너 실행 (8000번 포트로 실행)
            docker run -d -p 8000:8000 --name edison-ai-server clairekwak/edison_ai:${{ github.sha }}
            
            # 오래된 이미지 삭제
            docker image prune -af

            # nginx 설정 반영
            sudo rm -rf /etc/nginx/sites-enabled/ai.umcedison.site.conf || true
            sudo rm -rf /etc/nginx/sites-available/ai.umcedison.site.conf || true
            
            # [ ⭐️ 수정 ⭐️ ] /tmp/nginx.conf 대신 홈 디렉터리(~/nginx.conf)에서 파일을 이동
            sudo mv ~/nginx.conf /etc/nginx/sites-available/ai.umcedison.site.conf
            
            # 심볼릭 링크 생성
            sudo ln -s /etc/nginx/sites-available/ai.umcedison.site.conf \
                       /etc/nginx/sites-enabled/ai.umcedison.site.conf
            
            # Certbot용 디렉터리 생성
            sudo mkdir -p /var/www/certbot
            sudo chown www-data:www-data /var/www/certbot || true
            
            # Nginx 테스트 및 재시작
            sudo nginx -t && sudo systemctl reload nginx
