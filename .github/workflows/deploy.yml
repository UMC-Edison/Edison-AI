name: Deploy AI Server to AWS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          tags: clairekwak/edison_ai:${{ github.sha }}
          push: true

      # 'Upload nginx config' (scp-action) 단계는 삭제되었습니다.

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            docker pull clairekwak/edison_ai:${{ github.sha }}

            # 기존 컨테이너 중지 및 삭제
            docker stop edison-ai-server || true
            docker rm edison-ai-server || true

            # 새 컨테이너 실행 (8000번 포트로 실행)
            docker run -d -p 8000:8000 --name edison-ai-server clairekwak/edison_ai:${{ github.sha }}
            
            # 오래된 이미지 삭제
            docker image prune -af

            # [ ⭐️ 핵심 수정 ⭐️ ]
            # EC2 서버에서 직접 Nginx 설정 파일을 생성합니다.
            cat << 'EOF' | sudo tee /tmp/nginx.conf
server {
    listen 80;
    listen [::]:80;

    server_name ai.umcedison.site;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 그 외 모든 HTTP 요청은 HTTPS로
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name ai.umcedison.site;

    # SSL 인증서 경로 (Let's Encrypt) 
    ssl_certificate     /etc/letsencrypt/live/ai.umcedison.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ai.umcedison.site/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass         http://localhost:8000; # 8000번 포트로 프록시
        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

            # nginx 설정 반영 (rm -rf 로 혹시 모를 디렉터리/파일 모두 삭제)
            sudo rm -rf /etc/nginx/sites-enabled/ai.umcedison.site.conf || true
            sudo rm -rf /etc/nginx/sites-available/ai.umcedison.site.conf || true
            
            # /tmp에 생성된 파일을 sites-available로 이동
            sudo mv /tmp/nginx.conf /etc/nginx/sites-available/ai.umcedison.site.conf
            
            # 심볼릭 링크 생성
            sudo ln -s /etc/nginx/sites-available/ai.umcedison.site.conf \
                       /etc/nginx/sites-enabled/ai.umcedison.site.conf
            
            # Certbot용 디렉터리 생성
            sudo mkdir -p /var/www/certbot
            sudo chown www-data:www-data /var/www/certbot || true
            
            # Nginx 테스트 및 재시작
            sudo nginx -t && sudo systemctl reload nginx
